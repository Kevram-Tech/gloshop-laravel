name: Deploy on production mode (pressingelegance.com)

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build Docker image
        run: |
          docker build -t pretapp-admin:${{ github.sha }} .
          docker tag pretapp-admin:${{ github.sha }} pretapp-admin:latest
          docker save pretapp-admin:latest | gzip > app-image.tar.gz

      - name: üì¶ Create deployment archive
        run: |
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='vendor' \
              --exclude='.env' \
              --exclude='docker.env' \
              --exclude='storage/logs' \
              --exclude='storage/framework/cache' \
              --exclude='storage/framework/sessions' \
              --exclude='storage/framework/views' \
              --exclude='bootstrap/cache' \
              --exclude='tests' \
              --exclude='.phpunit.cache' \
              --exclude='certbot_data' \
              --exclude='certbot_www' \
              --exclude='deploy.tar.gz' \
              --exclude='app-image.tar.gz' \
              --exclude='*.log' \
              -czf /tmp/deploy.tar.gz .
          mv /tmp/deploy.tar.gz ./deploy.tar.gz

      - name: üì§ Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          source: "deploy.tar.gz,app-image.tar.gz"
          target: ${{ secrets.SFTP_ADMIN_DEPLOY_PATH || '/var/www/pretapp-admin' }}

      - name: üìÇ Extract files on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USERNAME }}
          password: ${{ secrets.SFTP_PASSWORD }}
          port: ${{ secrets.SFTP_PORT || 22 }}
          script: |
            cd ${{ secrets.SFTP_ADMIN_DEPLOY_PATH || '/var/www/pretapp-admin' }}

            # Extraire les fichiers
            echo "üì¶ Extraction des fichiers..."
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # Charger l'image Docker
            echo "üê≥ Chargement de l'image Docker..."
            docker load < app-image.tar.gz || true
            rm app-image.tar.gz

            # V√©rifier que docker.env existe
            if [ ! -f docker.env ]; then
              echo "‚ö†Ô∏è  docker.env n'existe pas. Cr√©ation depuis docker.env.example..."
              if [ -f docker.env.example ]; then
                cp docker.env.example docker.env
                echo "‚ö†Ô∏è  ATTENTION: Configurez docker.env avec vos valeurs!"
              fi
            fi

            # V√©rifier que DB_HOST est configur√©
            if ! grep -q "DB_HOST=host.docker.internal" docker.env 2>/dev/null && ! grep -q "DB_HOST=" docker.env 2>/dev/null; then
              echo "‚ö†Ô∏è  Configuration DB_HOST manquante dans docker.env"
              echo "   Ajoutez: DB_HOST=host.docker.internal"
            fi

            # Arr√™ter les conteneurs existants
            echo "üõë Arr√™t des conteneurs existants..."
            docker-compose -f docker-compose.prod.yml down || true

            # Reconstruire et red√©marrer les conteneurs
            echo "üöÄ D√©marrage des nouveaux conteneurs..."
            docker-compose -f docker-compose.prod.yml up -d --build

            # Attendre que les services d√©marrent
            echo "‚è≥ Attente du d√©marrage des services..."
            sleep 15

            # V√©rifier le statut
            echo "üìä Statut des conteneurs:"
            docker-compose -f docker-compose.prod.yml ps

            # Nettoyer les anciennes images
            echo "üßπ Nettoyage des images Docker inutilis√©es..."
            docker image prune -f || true

            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"